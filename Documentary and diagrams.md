# ПРОЕКТИРОВАНИЕ

Во втором разделе данной работы рассмотрено проектирование бота для веб-приложения Telegram, анализирующего эмоции в полученном голосовом сообщении.

Для корректной реализации бота, необходимо определить функциональные требования к приложению, основные компоненты, их взаимосвязи, а также происходящие в нем процессы. Это включает в себя разработку схемы архитектуры, определение ролей и задач каждого компонента, а также построение последовательности операций, необходимых для достижения функциональности. Для этого необходимо построить диаграммы, описывающие работу будущего приложения, и определить итоговую архитектуру.

## Функциональные требования

Реализация выбранного бота должна выполнять следующие функциональные требования:

1. бот должен при запуске командой /start отправлять приветственное сообщение;
2. бот должен в реальном времени обрабатывать и определять тип приходящего сообщения;
3. в случае неправильного типа, бот должен уведомлять пользователя об ошибке;
4. бот должен обрабатывать входящее голосовое сообщение;
5. обработка должна переводить голосовое сообщение в текстовый формат;
6. текст должен анализироваться на эмоциональную окраску;
7. результат работы бота должен отправляться пользователю.

Выполнение всех указанных функциональных требований позволит решать обозначенную задачу.

## Диаграмма компонентов UML

Диаграмма компонентов в нотации UML представлена на рисунке 1.


![UML](https://github.com/user-attachments/assets/3b084ecd-f3dc-4b1f-b9a5-07e0be386b73)

Рисунок 1 – Архитектура бота в диаграмме UML

Основными компонентами архитектуры являются:

1. voice message handler – компонент, отвечающий за взаимодействие с данными пользователя. Основной задачей компонента является обработка приходящих сообщений. Достигается это при помощи взаимодействия с библиотекой Telebot, которая предоставляет простой интерфейс взаимодействия с Telegram Bot API. Функционал библиотеки позволяет обрабатывать сообщения любого типа, настраивать шаблоны реагирования на эти сообщения. При инициализации чата, должно отправляться стартовое сообщение. Все сообщения от пользователя, кроме голосовых, должны вызывать ошибку, отправляемую пользователю. В случае получения голосового сообщения, компонент должен определять имя необходимого файла и загружать его, а затем вызывать работу следующего компонента;
2. audio transcriber – компонент, отвечающий за обработку аудиофайла. Попадающая в данный компонент аудиодорожка должна проходить обработку моделью Whisper. В процессе обработки, аудиофайл переводится в текстовый формат и подается в следующий компонент;
3. tone analyzer – компонент, производящий анализ тональности. Для обработки текста необходимо произвести токенизацию. Для этого текст поступает в компонент Tokenizator, в котором текст разбивается на токены. Далее, токены необходимо закодировать их порядковыми индексами в словаре, добавив PAD-токены и другие специальные токены. Затем, полученные индексы и список attention mask, указывающий, является ли данный токен PAD-токеном, должны быть конвертированы в тензоры и поданы в компонент Classificator. В нем происходит классификация входящего текста, загруженная модель выдает предсказание о том, какую эмоциональную окраску несет текст. Полученное предсказание передается в следующий компонент;
4. logit handler – компонент, отвечающий за обработку получившихся предсказаний, и отправляющий пользователю результат работы бота. Приходящие в него тензоры переводятся в формат массивов, сравниваются между собой, и по результатам сравнения пользователю отправляется результаты работы компонентов audio transcriber и tone analyzer.

## Проектирование процессов IDEF0

Для описания всех процессов, обозначенных в компонентах нашей архитектуры, была построена диаграмма в нотации IDEF0.

![IDEF0 0](https://github.com/user-attachments/assets/f9e352a9-35cc-49ca-82cc-71917c03fd26)

Рисунок 2 – Основная схема

На рисунке 2 изображена основная схема работы бота. Главный принцип работы – получение сообщения, обработка и отправка ответа.

![IDEF0 1](https://github.com/user-attachments/assets/5c9850b1-6650-4d2a-adb4-641a583274e8)

Рисунок 3 – Декомпозиция A0

Декомпозиция A0 на рисунке 3 изображает основные процессы, происходящие в работающем приложении. Ими являются следующие этапы работы:

1. инициализация бота – процесс запуска диалога с ботом, посредством введения команды /start;
2. обработка сообщения – процесс получения необходимой информации из сообщения пользователя;
3. обработка аудиофайла – процесс транскрибации аудиофайла при помощи модели Whisper, для дальнейшего анализа;
4. определение эмоции – процесс анализирования текста на эмоциональную окраска при помощи обученной модели BERT;
5. отправка результатов – процесс обработки предсказания и формирования сообщения для пользователя.

![IDEF0 2](https://github.com/user-attachments/assets/1813492f-44ce-462b-8b9c-a4fe7a29f7e3)

Рисунок 4 – Декомпозиция A1

Порядок проведения инициализации бота Telegram описан в декомпозиции A1, на рисунке 4. Этот этап происходит во время первого взаимодействия пользователя с ботом. Основные шаги– определение команды /start, и ожидание сообщений пользователя.

![IDEF0 3 drawio](https://github.com/user-attachments/assets/0ae51a91-cf3d-4520-8804-9dd153d56951)

Рисунок 5 – Декомпозиция A2

Процесс обработки сообщения рассмотрен в декомпозиции A2, на рисунке 5. В данном процессе бот получает необходимую информацию из сообщения пользователя, проверяет тип данных, и либо выдает пользователю ошибку, либо загружает аудиофайл.

![Проектирование IDEF drawio](https://github.com/user-attachments/assets/535564b5-6346-44ce-b1e0-7fcd0bf55c0d)

Рисунок 6 – Декомпозиция A3

В декомпозиции A3, на рисунке 6, проиллюстрирован процесс транскрибации аудиосообщения. Загружается модель Whisper, которая переводит аудиофайл в спектрограмму, и на основе этой спектрограммы предсказывает текст, который в дальнейшем будет отправлен на определение эмоции.

![Проектирование IDEF drawio (1)](https://github.com/user-attachments/assets/e9dd2b4c-0891-4490-b887-33ff41c8f6f4)

Рисунок 7 – Декомпозиция A4

Декомпозиция A4, на рисунке 7, представляет основной этапы работы дообученной модели BERT, токенизацию и классификацию. В процессе токенизации текст переводится в порядковые индексы распознанных токенов. В процессе классификации, токены и их лейблы проходят обработку моделью и на выходе возвращает тензор с предсказанием. В результате работы данного процесса дальше отправляется полученное предсказание.

![Проектирование IDEF drawio (2)](https://github.com/user-attachments/assets/5346df81-4466-4cb7-aeaa-0c82b2a129ab)

Рисунок 8 – Декомпозиция A5

Итоговое формирование ответа рассмотрено на рисунке 8, в декомпозиции A5. Для реализации удобного сравнения предсказаний, полученный тензор конвертируется в массив, затем элементы массива сравниваются между собой и по результатам сравнения выбирается наиболее высокое значение эмоции. Затем, пользователю отправляется ответ с полученной эмоцией и результатом транскрибации.

## Результаты проектирования

В результате проведенного проектирования, нами были сформулированы функциональные требования, а также выстроена архитектура приложения. Бот состоит из 4 основных компонентов, которые включают в себя Voice message handler, Audio transcriber, Tone analyzer и Logit handler. Процесс проектирования включал в себя описание архитектуры системы, построение UML диаграмм компонентов, а также моделирование процессов в нотации IDEF0.

Все процессы, происходящие во время работы бота, были описаны и визуализированы в диаграмме IDEF0, что помогло выделить основные функциональные блоки, их взаимосвязь друг с другом, а также последовательность исполнения. На основе составленных диаграмм и описаний можно производить реализацию приложения.
